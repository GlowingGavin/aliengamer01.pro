<script>
let game = new Chess();
const board = document.getElementById("board");
const turnDisplay = document.getElementById("turn");
let engine, ready=false, lastEval=0, analyzing=false;

const evalColors={
  best:"#90ee90",excellent:"#4caf50",good:"#2e8b57",
  inaccuracy:"#ffe700",mistake:"#ff9800",blunder:"#ff0000"
};
function classify(diff){
  diff=Math.abs(diff);
  if(diff<=15)return"best";
  if(diff<=40)return"excellent";
  if(diff<=100)return"good";
  if(diff<=200)return"inaccuracy";
  if(diff<=400)return"mistake";
  return"blunder";
}

function drawBoard(){
  board.innerHTML="";
  const ranks=[8,7,6,5,4,3,2,1],files=["a","b","c","d","e","f","g","h"];
  for(const r of ranks){
    for(const f of files){
      const id=f+r;
      const sq=document.createElement("div");
      sq.id=id;
      sq.className="square "+(((files.indexOf(f)+ranks.indexOf(r))%2===0?"light":"dark"));
      const piece=game.get(id);
      if(piece){
        const img=document.createElement("img");
        img.src=`pieces/${piece.color}${piece.type}.png`;
        img.className="piece";
        img.draggable=true;
        sq.appendChild(img);
      }
      board.appendChild(sq);
    }
  }
  turnDisplay.textContent=(game.turn()==="w")?"White to move":"Black to move";
  enableDragDrop();
}

function highlightSquare(sq,type){
  const el=document.getElementById(sq);
  if(!el)return;
  el.querySelectorAll(".overlay,.moveIcon").forEach(e=>e.remove());
  const ov=document.createElement("div");
  ov.className="overlay";
  ov.style.background=evalColors[type]||"#8888";
  const icon=document.createElement("img");
  icon.className="moveIcon";
  icon.src=`move_classifications/${type}.png`;
  el.append(ov,icon);
}

function enableDragDrop(){
  let dragged=null,source=null;
  document.querySelectorAll(".piece").forEach(p=>{
    p.addEventListener("dragstart",e=>{
      source=e.target.parentElement.id;
      dragged=e.target;
      setTimeout(()=>dragged.style.visibility="hidden",0);
    });
    p.addEventListener("dragend",()=>{dragged.style.visibility="visible";dragged=null;});
  });
  document.querySelectorAll(".square").forEach(sq=>{
    sq.addEventListener("dragover",e=>e.preventDefault());
    sq.addEventListener("drop",e=>{
      e.preventDefault();
      const target=e.target.closest(".square").id;
      if(!source)return;
      const move=game.move({from:source,to:target,promotion:"q"});
      if(move){drawBoard();evaluateMove(move);}
      source=null;
    });
  });
}

async function getEval(fen){
  return new Promise(resolve=>{
    let result=null;
    const handler=e=>{
      const msg=e.data;
      if(typeof msg!=="string")return;
      if(msg.includes("score cp")){
        const m=msg.match(/cp (-?\d+)/);
        if(m){result=parseInt(m[1]);}
      }
      if(msg.includes("bestmove")){
        engine.removeEventListener("message",handler);
        resolve(result);
      }
    };
    engine.addEventListener("message",handler);
    engine.postMessage("position fen "+fen);
    engine.postMessage("go depth 12");
  });
}

async function evaluateMove(move){
  if(!ready||!engine||analyzing)return;
  analyzing=true;
  const newFen=game.fen();
  const newEval=await getEval(newFen);
  if(newEval===null){analyzing=false;return;}
  const diff=newEval-lastEval;
  const type=classify(diff);
  highlightSquare(move.to,type);
  lastEval=newEval;
  analyzing=false;
}

window.addEventListener("load",async()=>{
  try{
    engine=new Worker("./js/stockfish.js");
    ready=true;
    console.log("Stockfish ready");
    drawBoard();
    // get initial evaluation
    lastEval = await getEval(game.fen());
    console.log("Initial eval:", lastEval);
  }catch(err){
    console.error("Stockfish load failed",err);
    turnDisplay.textContent="⚠️ Engine failed to start";
  }
});
</script>
