<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AlienGamer Chess — Live Review</title>

<!-- ✅ Local Stockfish (place at /js/stockfish.js) -->
<script src="js/stockfish.js"></script>

<style>
  body {
    background:#111;
    color:#fff;
    font-family:Arial;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    min-height:100vh;
    margin:0;
  }
  #board {
    display:grid;
    grid-template-columns:repeat(8,80px);
    grid-template-rows:repeat(8,80px);
    border:4px solid #000;
    position:relative;
  }
  .square {
    width:80px;height:80px;
    display:flex;justify-content:center;align-items:center;
    position:relative;
  }
  .light { background:#f0d9b5; }
  .dark  { background:#b58863; }
  .piece { width:72px;height:72px;cursor:grab; }
  #turn { font-size:1.3rem;margin-top:15px; }

  .overlay {
    position:absolute;top:0;left:0;width:100%;height:100%;
    opacity:0.5;border-radius:2px;z-index:1;
  }
  .moveIcon {
    position:absolute;top:2px;right:2px;width:28px;height:28px;
    z-index:2;pointer-events:none;
  }

  #promoMenu {
    position:fixed;top:50%;left:50%;
    transform:translate(-50%,-50%);
    background:#222;border:2px solid #0ff;border-radius:10px;
    padding:15px;display:none;gap:10px;z-index:9999;
  }
  #promoMenu img {
    width:60px;height:60px;cursor:pointer;
    border:2px solid transparent;border-radius:6px;
  }
  #promoMenu img:hover { border-color:#0ff; }
</style>
</head>
<body>
  <div id="board"></div>
  <div id="turn">Loading engine …</div>
  <div id="promoMenu"></div>

<script>
/* ========== BOARD SETUP ========== */
const files=['a','b','c','d','e','f','g','h'],ranks=[8,7,6,5,4,3,2,1];
const board=document.getElementById('board'),
      turnDisplay=document.getElementById('turn'),
      promoMenu=document.getElementById('promoMenu');
let S={},turn='w';

const START={
 a8:'br',b8:'bn',c8:'bb',d8:'bq',e8:'bk',f8:'bb',g8:'bn',h8:'br',
 a7:'bp',b7:'bp',c7:'bp',d7:'bp',e7:'bp',f7:'bp',g7:'bp',h7:'bp',
 a2:'wp',b2:'wp',c2:'wp',d2:'wp',e2:'wp',f2:'wp',g2:'wp',h2:'wp',
 a1:'wr',b1:'wn',c1:'wb',d1:'wq',e1:'wk',f1:'wb',g1:'wn',h1:'wr'
};
S=structuredClone(START);

function colorOf(p){return p?p[0]:null;}
function drawBoard(){
  board.innerHTML='';
  for(const r of ranks){
    for(const f of files){
      const id=f+r;
      const sq=document.createElement('div');
      sq.id=id;
      sq.className='square '+(((files.indexOf(f)+ranks.indexOf(r))%2===0)?'light':'dark');
      const p=S[id];
      if(p){
        const img=document.createElement('img');
        img.src=`pieces/${p}.png`;
        img.className='piece';
        img.draggable=true;
        sq.appendChild(img);
      }
      board.appendChild(sq);
    }
  }
  enableDnD();
  turnDisplay.textContent=(turn==='w')?'White to move':'Black to move';
}

/* ========== MOVE HANDLING ========== */
function isLegalMove(from,to){
  if(!S[from])return false;
  if(colorOf(S[from])!==turn)return false;
  if(from===to)return false;
  return true;
}
function applyMove(from,to){
  S[to]=S[from];delete S[from];
}
function afterMove(lastMove){
  turn=(turn==='w')?'b':'w';
  drawBoard();
  evaluateMove(lastMove);
}

/* ========== EVALUATION & OVERLAYS ========== */
const colors={
  best:'#90ee90',excellent:'#4CAF50',good:'#2e8b57',
  inaccuracy:'#f1c232',mistake:'#ff9800',blunder:'#ff0000'
};
function classify(diff){
  if(diff<=10)return'best';
  if(diff<=30)return'excellent';
  if(diff<=70)return'good';
  if(diff<=150)return'inaccuracy';
  if(diff<=300)return'mistake';
  return'blunder';
}
function highlightSquare(sq,type){
  const el=document.getElementById(sq);
  if(!el)return;
  el.querySelectorAll('.overlay,.moveIcon').forEach(e=>e.remove());
  const overlay=document.createElement('div');
  overlay.className='overlay';overlay.style.background=colors[type];
  const icon=document.createElement('img');
  icon.className='moveIcon';icon.src=`move_classifications/${type}.png`;
  el.appendChild(overlay);el.appendChild(icon);
}

/* ========== STOCKFISH ENGINE ========== */
let engine=null,ready=false;
window.addEventListener("load",()=>{
  if(typeof Stockfish!=="function"){
    turnDisplay.textContent="⚠️ Stockfish engine failed to load.";
    console.error("Stockfish not defined — check /js/stockfish.js path");
    return;
  }
  engine=Stockfish();
  ready=true;
  turnDisplay.textContent="White to move";
  drawBoard();
});

async function evaluateMove(move){
  if(!ready||!engine)return;
  // For now, simulate eval visually (no delay)
  const diff=Math.floor(Math.random()*350);
  const type=classify(diff);
  highlightSquare(move.to,type);
}

/* ========== DRAG & DROP ========== */
function enableDnD(){
  let dragged=null,source=null;
  document.querySelectorAll('.piece').forEach(pc=>{
    pc.addEventListener('dragstart',e=>{
      const sq=e.target.parentElement.id;
      if(colorOf(S[sq])!==turn){e.preventDefault();return;}
      dragged=e.target;source=sq;setTimeout(()=>dragged.style.visibility='hidden',0);
    });
    pc.addEventListener('dragend',()=>{if(dragged)dragged.style.visibility='visible';dragged=null;});
  });
  document.querySelectorAll('.square').forEach(sq=>{
    sq.addEventListener('dragover',e=>e.preventDefault());
    sq.addEventListener('drop',e=>{
      e.preventDefault();
      const target=e.target.closest('.square').id;
      if(!dragged||!source)return;
      if(isLegalMove(source,target)){
        applyMove(source,target);
        afterMove({from:source,to:target});
      }
      source=null;
    });
  });
}
</script>
</body>
</html>
